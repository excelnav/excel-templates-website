{{ define "main" }}
<div class="container">
    <div class="search-page">
        <header class="search-header">
            <h1>Search Templates</h1>
            <p class="search-description">Find the perfect Excel template for your needs</p>
            
            <!-- 搜索表单 -->
            <div class="search-form-container">
                <form class="search-form-main" id="searchForm">
                    <input type="search" id="searchInput" placeholder="Search templates..." class="search-input-main" aria-label="Search">
                    <button type="submit" class="search-button-main" aria-label="Search">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
                            <path d="m21 21-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </form>
            </div>
        </header>

        <!-- 搜索结果 -->
        <div class="search-results">
            <div id="searchResults" class="search-results-container">
                <div class="search-placeholder">
                    <p>Enter a search term to find templates</p>
                </div>
            </div>
            
            <div id="noResults" class="no-results" style="display: none;">
                <h3>No templates found</h3>
                <p>Try different keywords or browse our <a href="/categories/">categories</a></p>
            </div>
        </div>
    </div>
</div>

<style>
.search-page {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem 0;
}

.search-header {
    text-align: center;
    margin-bottom: 3rem;
}

.search-header h1 {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    color: var(--text-primary);
}

.search-description {
    font-size: 1.1rem;
    color: var(--text-secondary);
    margin-bottom: 2rem;
}

.search-form-container {
    max-width: 500px;
    margin: 0 auto;
}

.search-form-main {
    display: flex;
    background: white;
    border: 2px solid var(--border-color);
    border-radius: 50px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.search-form-main:focus-within {
    border-color: var(--primary-color);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
}

.search-input-main {
    flex: 1;
    padding: 1rem 1.5rem;
    border: none;
    outline: none;
    font-size: 1rem;
    background: transparent;
}

.search-button-main {
    padding: 1rem 1.5rem;
    background: var(--primary-color);
    color: white;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.search-button-main:hover {
    background: var(--primary-hover);
}

.search-results-container {
    margin-top: 2rem;
}

.search-placeholder {
    text-align: center;
    padding: 3rem 0;
    color: var(--text-muted);
}

.search-result-item {
    background: white;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
}

.search-result-item:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.search-result-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.search-result-title a {
    color: var(--text-primary);
    text-decoration: none;
    font-weight: 600;
}

.search-result-title a:hover {
    color: var(--primary-color);
}

.search-result-description {
    margin-bottom: 1rem;
    color: var(--text-secondary);
    line-height: 1.6;
}

.search-result-meta {
    display: flex;
    gap: 1rem;
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.search-result-category {
    background: var(--background-light);
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    text-decoration: none;
    color: var(--primary-color);
    font-weight: 500;
}

.no-results {
    text-align: center;
    padding: 3rem 0;
}

.no-results h3 {
    margin-bottom: 1rem;
    color: var(--text-primary);
}

.no-results p {
    color: var(--text-secondary);
}

.no-results a {
    color: var(--primary-color);
    text-decoration: none;
}

.no-results a:hover {
    text-decoration: underline;
}

@media (max-width: 768px) {
    .search-page {
        padding: 1rem;
    }
    
    .search-header h1 {
        font-size: 2rem;
    }
    
    .search-form-main {
        border-radius: 25px;
    }
    
    .search-input-main,
    .search-button-main {
        padding: 0.75rem 1rem;
    }
}
</style>

<script>
// 搜索数据 - 从Hugo的JSON输出获取
let searchData = [];

// 获取搜索数据
async function loadSearchData() {
    try {
        console.log('Loading search data...');
        const response = await fetch('/index.json');
        searchData = await response.json();
        console.log('Search data loaded:', searchData.length, 'items');
        console.log('First item:', searchData[0]);
    } catch (error) {
        console.error('Failed to load search data:', error);
    }
}

// 执行搜索
function performSearch(query) {
    console.log('Performing search for:', query);
    console.log('Search data available:', searchData.length, 'items');
    
    if (!query || query.trim().length < 2) {
        showPlaceholder();
        return;
    }

    const searchTerm = query.toLowerCase().trim();
    console.log('Search term:', searchTerm);
    
    const results = searchData.filter(item => {
        const titleMatch = item.title.toLowerCase().includes(searchTerm);
        const contentMatch = item.content.toLowerCase().includes(searchTerm);
        const categoryMatch = item.categories && item.categories.some(cat => cat.toLowerCase().includes(searchTerm));
        const tagMatch = item.tags && item.tags.some(tag => tag.toLowerCase().includes(searchTerm));
        
        return titleMatch || contentMatch || categoryMatch || tagMatch;
    });

    console.log('Search results:', results.length, 'items found');
    console.log('Results:', results);
    displayResults(results, searchTerm);
}

// 显示搜索结果
function displayResults(results, searchTerm) {
    const resultsContainer = document.getElementById('searchResults');
    const noResultsDiv = document.getElementById('noResults');

    if (results.length === 0) {
        resultsContainer.style.display = 'none';
        noResultsDiv.style.display = 'block';
        return;
    }

    noResultsDiv.style.display = 'none';
    resultsContainer.style.display = 'block';

    const resultsHTML = results.map(item => {
        const highlightedTitle = highlightSearchTerm(item.title, searchTerm);
        const highlightedContent = highlightSearchTerm(item.summary || item.content.substring(0, 200), searchTerm);
        
        return `
            <div class="search-result-item">
                <h3 class="search-result-title">
                    <a href="${item.permalink}">${highlightedTitle}</a>
                </h3>
                <p class="search-result-description">${highlightedContent}...</p>
                <div class="search-result-meta">
                    ${item.categories ? item.categories.map(cat => 
                        `<a href="/categories/${cat.toLowerCase()}/" class="search-result-category">${cat}</a>`
                    ).join('') : ''}
                </div>
            </div>
        `;
    }).join('');

    resultsContainer.innerHTML = `
        <div class="search-results-header">
            <p>Found ${results.length} template${results.length !== 1 ? 's' : ''} for "${searchTerm}"</p>
        </div>
        ${resultsHTML}
    `;
}

// 高亮搜索词
function highlightSearchTerm(text, searchTerm) {
    const regex = new RegExp(`(${searchTerm})`, 'gi');
    return text.replace(regex, '<mark>$1</mark>');
}

// 显示占位符
function showPlaceholder() {
    const resultsContainer = document.getElementById('searchResults');
    const noResultsDiv = document.getElementById('noResults');
    
    noResultsDiv.style.display = 'none';
    resultsContainer.style.display = 'block';
    resultsContainer.innerHTML = `
        <div class="search-placeholder">
            <p>Enter a search term to find templates</p>
        </div>
    `;
}

// 从URL参数获取搜索词
function getSearchQuery() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('q') || '';
}

// 初始化搜索
document.addEventListener('DOMContentLoaded', async function() {
    await loadSearchData();
    
    const searchInput = document.getElementById('searchInput');
    const searchForm = document.getElementById('searchForm');
    
    // 从URL获取搜索词并执行搜索
    const initialQuery = getSearchQuery();
    if (initialQuery) {
        searchInput.value = initialQuery;
        performSearch(initialQuery);
    }
    
    // 搜索表单提交
    searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const query = searchInput.value;
        performSearch(query);
        
        // 更新URL
        const newUrl = new URL(window.location);
        newUrl.searchParams.set('q', query);
        window.history.pushState({}, '', newUrl);
    });
    
    // 实时搜索（可选）
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const query = this.value;
            if (query.length >= 2) {
                performSearch(query);
            } else if (query.length === 0) {
                showPlaceholder();
            }
        }, 300);
    });
});
</script>
{{ end }}